<div class="edit" (click)="assigneeOpen = false">
  <form [formGroup]="editForm" class="edit-form">
    <label>Title</label>
    <input formControlName="title" placeholder="Enter a title" />

    <label>Description</label>
    <textarea formControlName="description" placeholder="Enter a Description"></textarea>

    <label>Due date</label>
    <input type="date" formControlName="dueDate" />

    <div class="priority-row">
      <label>Priority</label>

      <div class="priority">
        <button
          type="button"
          class="prio-urgent"
          [class.active]="editForm.value.priority === 'urgent'"
          (click)="editForm.patchValue({ priority: 'urgent' })"
        >
          Urgent
          <img src="img/icons/prio-urgent.svg" alt="Urgent" />
        </button>

        <button
          type="button"
          class="prio-medium"
          [class.active]="editForm.value.priority === 'medium'"
          (click)="editForm.patchValue({ priority: 'medium' })"
        >
          Medium
          <img src="img/icons/prio-medium.svg" alt="Medium" />
        </button>

        <button
          type="button"
          class="prio-low"
          [class.active]="editForm.value.priority === 'low'"
          (click)="editForm.patchValue({ priority: 'low' })"
        >
          Low
          <img src="img/icons/prio-low.svg" alt="Low" />
        </button>
      </div>
    </div>

    <div class="assigned-row">
      <label>Assigned to</label>

      <div class="assigned-dropdown" (click)="$event.stopPropagation()">
        <div class="assigned-input" (click)="assigneeOpen = !assigneeOpen">
          <input type="text" placeholder="Select contacts to assign" readonly value="" />
          <span class="dropdown-arrow">&#9662;</span>
        </div>

        @if (assigneeOpen) {
          <div class="dropdown-list">
            <ng-container *ngFor="let c of (contacts ?? [])">
              <div
                *ngIf="c.id"
                class="dropdown-item"
                [class.selected]="isAssigned(c.id)"
                (click)="toggleAssignee(c.id, !isAssigned(c.id)); $event.stopPropagation()"
              >
                <span class="avatar" [ngStyle]="{ background: c.color }">
                  {{ getInitials(c.name) }}
                </span>

                <span class="name">{{ c.name }}</span>

                <input
                  type="checkbox"
                  [checked]="isAssigned(c.id)"
                  (click)="$event.stopPropagation(); toggleAssignee(c.id, $event.target.checked)"
                />
              </div>
            </ng-container>
          </div>
        }
      </div>

      <div class="assigned-badges">
        <span
          *ngFor="let uid of selectedAssigneeIds"
          class="badge-avatar"
          [ngStyle]="{ background: getContactColor(uid) }"
        >
          {{ getContactInitials(uid) }}
        </span>
      </div>
    </div>

    <div class="subtasks-row">
      <label>Subtasks</label>

      <div class="subtask-input-wrapper" [class.focused]="subtaskFocus">
        <input
          [(ngModel)]="newSubtaskTitle"
          [ngModelOptions]="{ standalone: true }"
          (focus)="subtaskFocus = true"
          (keydown.enter)="$event.preventDefault(); addSubtask()"
          placeholder="Add new subtask"
          name="subtaskInput"
        />

        <span class="subtask-icons">
          <ng-container *ngIf="!subtaskFocus && !newSubtaskTitle; else activeIcons">
            <button type="button" class="icon-btn" (click)="subtaskFocus = true">
              <img src="img/icons/add.svg" alt="Add" />
            </button>
          </ng-container>

          <ng-template #activeIcons>
            <button type="button" class="icon-btn" (click)="clearSubtaskInput(); subtaskFocus = false">
              <img src="img/icons/close_black.svg" alt="Clear" />
            </button>

            <span class="divider"></span>

            <button type="button" class="icon-btn" (click)="addSubtask()">
              <img src="img/icons/check-hover.svg" alt="Add" />
            </button>
          </ng-template>
        </span>
      </div>

      <ul class="subtask-list">
        <li *ngFor="let s of subtasks">
          <ng-container *ngIf="editSubtaskId !== s.id; else editTpl">
            <span class="subtask-bullet">â€¢</span>
            <span class="subtask-title">{{ s.title }}</span>

            <div class="item-actions">
              <button type="button" class="icon-btn" (click)="startEditSubtask(s.id, s.title)">
                <img src="img/icons/edit.svg" alt="Edit" />
              </button>

              <span class="divider-small"></span>

              <button type="button" class="icon-btn" (click)="removeSubtask(s.id)">
                <img src="img/icons/delete.svg" alt="Delete" />
              </button>
            </div>
          </ng-container>

          <ng-template #editTpl>
            <div class="edit-wrapper">
              <input
                [(ngModel)]="editSubtaskTitle"
                [ngModelOptions]="{ standalone: true }"
                class="edit-input"
              />

              <div class="edit-actions">
                <button type="button" class="icon-btn" (click)="removeSubtask(s.id)">
                  <img src="img/icons/delete.svg" alt="Delete" />
                </button>

                <span class="divider-small"></span>

                <button type="button" class="icon-btn" (click)="saveEditSubtask(s.id)">
                  <img src="img/icons/check-hover.svg" alt="Save" />
                </button>
              </div>
            </div>
          </ng-template>
        </li>
      </ul>
    </div>
  </form>
</div>

