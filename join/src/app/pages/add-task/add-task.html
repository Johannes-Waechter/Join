@if (showTaskAddedToast) {
<div class="toast" [class.toast--hide]="hideToast">
  <span>Task added to board</span>
  <img src="img/icons/board-active.svg" alt="" />
</div>
}

<div class="add-task-page" [class.page--toast-lock]="showTaskAddedToast">
  <header class="page-header">
    <h1>Add Task</h1>
  </header>

  <form [formGroup]="taskForm" class="content">
    <div class="left">
      <label for="title">Title<span>*</span></label>
      <input id="title" formControlName="title" placeholder="Enter a title" />
      <span class="error" role="alert" *ngIf="taskForm.get('title')?.invalid && taskForm.get('title')?.touched">This
        field is
        required</span>

      <label for="description">Description</label>
      <textarea id="description" formControlName="description" placeholder="Enter a Description"></textarea>

      <label for="dueDate">Due date<span>*</span></label>
      <input id="dueDate" #dateInput type="date" formControlName="dueDate" [min]="today" placeholder="dd/mm/yyyy"
        required (click)="dateInput.showPicker()" />
      <span class="error" role="alert" *ngIf="taskForm.get('dueDate')?.invalid && taskForm.get('dueDate')?.touched">This
        field is
        required</span>
    </div>

    <div class="right">
      <label id="priority-label">Priority</label>
      <div class="priority" role="group" aria-labelledby="priority-label">
        <button type="button" class="prio-urgent" [class.active]="taskForm.value.priority === 'Urgent'"
          [attr.aria-pressed]="taskForm.value.priority === 'Urgent'"
          (click)="taskForm.patchValue({ priority: 'Urgent' })">
          Urgent <img src="img/icons/prio-urgent.svg" alt="Dringend" />
        </button>
        <button type="button" class="prio-medium" [class.active]="taskForm.value.priority === 'Medium'"
          [attr.aria-pressed]="taskForm.value.priority === 'Medium'"
          (click)="taskForm.patchValue({ priority: 'Medium' })">
          Medium <img src="img/icons/prio-medium.svg" alt="Mittel" />
        </button>
        <button type="button" class="prio-low" [class.active]="taskForm.value.priority === 'Low'"
          [attr.aria-pressed]="taskForm.value.priority === 'Low'" (click)="taskForm.patchValue({ priority: 'Low' })">
          Low <img src="img/icons/prio-low.svg" alt="Niedrig" />
        </button>
      </div>

      <label>Assigned to</label>
      <div class="assigned-dropdown" (click)="$event.stopPropagation()">
        <div class="assigned-input" (click)="assigneeOpen = !assigneeOpen">
          <input type="text" placeholder="Select contacts to assign" readonly
            [value]="taskForm.value.assignedTo?.length ? '' : ''" />
          <img class="dropdown-arrow" [src]="assigneeOpen ? 'img/icons/dropup.svg' : 'img/icons/dropdown.svg'"
            alt="dropdown" />
        </div>
        <div class="dropdown-list" *ngIf="assigneeOpen">
          <ng-container *ngFor="let c of contacts">
            <div *ngIf="c.id" class="dropdown-item" [class.selected]="isAssigned(c.id)"
              (click)="toggleAssignee(c.id, !isAssigned(c.id)); $event.stopPropagation()">
              <span class="avatar" [ngStyle]="{ background: c.color }">{{
                getInitials(c.name)
                }}</span>
              <span class="name">{{ c.name }}</span>
              <img class="checkbox-icon" [src]="
                  isAssigned(c.id)
                    ? 'img/icons/checkbox-done.svg'
                    : 'img/icons/checkbox-todo.svg'
                " (click)="$event.stopPropagation(); toggleAssignee(c.id, !isAssigned(c.id))" alt="checkbox" />
            </div>
          </ng-container>
        </div>
      </div>
      <div class="assigned-badges">
        <span *ngFor="let uid of taskForm.value.assignedTo" class="badge-avatar"
          [ngStyle]="{ background: getContactColor(uid) }">
          {{ getContactInitials(uid) }}
        </span>
      </div>

      <label for="category">Category<span>*</span></label>

      <div class="select-wrapper">
        <select id="category" formControlName="category">
          <option value="">Select task category</option>
          <option value="user-story">User story</option>
          <option value="technical-task">Technical task</option>
        </select>

        <img class="dropdown-arrow select-arrow" src="img/icons/dropdown.svg" alt="Dropdown" aria-hidden="true" />
      </div>
      <span class="error" role="alert"
        *ngIf="taskForm.get('category')?.invalid && taskForm.get('category')?.touched">This field is
        required</span>

      <label for="subtask">Subtasks</label>

      <div class="subtask-input-wrapper">
        <input id="subtask" class="subtask-input" [(ngModel)]="newSubtaskTitle" [ngModelOptions]="{ standalone: true }"
          placeholder="Add new subtask" aria-label="Neuen Subtask hinzufügen" (focus)="subtaskFocus = true"
          (blur)="!newSubtaskTitle && (subtaskFocus = false)" (keydown.enter)="$event.preventDefault(); addSubtask()" />

        @if (subtaskFocus) {
        <div class="subtask-actions">
          <button type="button" class="icon-btn" (click)="clearSubtaskInput(); subtaskFocus = false"
            aria-label="Eingabe löschen">
            <img src="img/icons/close-small-dark.svg" alt="Löschen" />
          </button>

          <span class="divider" aria-hidden="true"></span>

          <button type="button" class="icon-btn" (click)="addSubtask()" aria-label="Subtask hinzufügen">
            <img src="img/icons/check-small-dark.svg" alt="Hinzufügen" />
          </button>
        </div>
        }
      </div>

      <ul class="subtask-list">
        @for (subtask of subtasks; track subtask.id) {
        <li (dblclick)="startEditSubtask(subtask.id, subtask.title)">
          @if (editSubtaskId !== subtask.id) {
          <span class="subtask-bullet">•</span>
          <span class="subtask-title">{{ subtask.title }}</span>

          <div class="item-actions">
            <button type="button" class="icon-btn" (click)="startEditSubtask(subtask.id, subtask.title)">
              <img src="img/icons/edit-hover.svg" alt="Edit" />
            </button>

            <span class="divider"></span>

            <button type="button" class="icon-btn" (click)="removeSubtask(subtask.id)">
              <img src="img/icons/delete.svg" alt="Delete" />
            </button>
          </div>
          } @else {
          <div class="edit-wrapper" (dblclick)="$event.stopPropagation()">
            <input [(ngModel)]="editSubtaskTitle" [ngModelOptions]="{ standalone: true }" class="edit-input" />

            <div class="edit-actions">
              <button type="button" class="icon-btn" (click)="removeSubtask(subtask.id)">
                <img src="img/icons/delete.svg" alt="Delete" />
              </button>

              <span class="divider"></span>

              <button type="button" class="icon-btn" (click)="saveEditSubtask(subtask.id)">
                <img src="img/icons/check-small-dark.svg" alt="Save" />
              </button>
            </div>
          </div>
          }
        </li>
        }
      </ul>

      <!-- Required-Hint für Mobile View (unter Subtasks) -->
      <span class="required-hint-mobile"><span class="asterisk">*</span>This field is required</span>
    </div>
  </form>

  <footer class="actions">
    <span class="required-hint"> <span class="asterisk">*</span>This field is required </span>

    <div class="action-buttons">
      <button class="clear" type="button" (click)="clearForm()">
        Clear
        <img class="btn-icon" src="img/icons/dialog_cancel.svg" alt="Clear" />
      </button>

      <button class="submit" type="button" (click)="createTask()">
        Create Task
        <img class="btn-icon" src="img/icons/dialog_check.svg" alt="Create" />
      </button>
    </div>
  </footer>
</div>